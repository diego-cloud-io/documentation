"use strict";(self.webpackChunkdiego=self.webpackChunkdiego||[]).push([[424],{3905:(e,t,n)=>{n.d(t,{Zo:()=>s,kt:()=>g});var a=n(7294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var p=a.createContext({}),d=function(e){var t=a.useContext(p),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},s=function(e){var t=d(e.components);return a.createElement(p.Provider,{value:t},e.children)},u="mdxType",c={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},m=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,o=e.originalType,p=e.parentName,s=l(e,["components","mdxType","originalType","parentName"]),u=d(n),m=r,g=u["".concat(p,".").concat(m)]||u[m]||c[m]||o;return n?a.createElement(g,i(i({ref:t},s),{},{components:n})):a.createElement(g,i({ref:t},s))}));function g(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var o=n.length,i=new Array(o);i[0]=m;var l={};for(var p in t)hasOwnProperty.call(t,p)&&(l[p]=t[p]);l.originalType=e,l[u]="string"==typeof e?e:r,i[1]=l;for(var d=2;d<o;d++)i[d]=n[d];return a.createElement.apply(null,i)}return a.createElement.apply(null,n)}m.displayName="MDXCreateElement"},1215:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>p,contentTitle:()=>i,default:()=>u,frontMatter:()=>o,metadata:()=>l,toc:()=>d});var a=n(7462),r=(n(7294),n(3905));const o={sidebar_position:5,title:"Operation Guidance"},i="Operation Guidance",l={unversionedId:"deployment-guide/operation-guidance",id:"deployment-guide/operation-guidance",title:"Operation Guidance",description:"Checking Diego Health",source:"@site/docs/deployment-guide/operation-guidance.md",sourceDirName:"deployment-guide",slug:"/deployment-guide/operation-guidance",permalink:"/documentation/docs/deployment-guide/operation-guidance",draft:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/deployment-guide/operation-guidance.md",tags:[],version:"current",sidebarPosition:5,frontMatter:{sidebar_position:5,title:"Operation Guidance"},sidebar:"deploymentSidebar",previous:{title:"Security",permalink:"/documentation/docs/deployment-guide/security"},next:{title:"Support",permalink:"/documentation/docs/deployment-guide/support"}},p={},d=[{value:"Checking Diego Health",id:"checking-diego-health",level:2},{value:"Check ArgoCD is running and available",id:"check-argocd-is-running-and-available",level:3},{value:"Check ArgoCD managed components are healthy",id:"check-argocd-managed-components-are-healthy",level:3},{value:"Check Diego Hub is available",id:"check-diego-hub-is-available",level:3},{value:"Backup &amp; Recovery",id:"backup--recovery",level:2},{value:"Recovery with EKS backup",id:"recovery-with-eks-backup",level:3},{value:"Recovery without EKS backup",id:"recovery-without-eks-backup",level:3},{value:"Recovery after Diego component failure",id:"recovery-after-diego-component-failure",level:3},{value:"Recovery from AZ failure",id:"recovery-from-az-failure",level:3},{value:"Routine Maintainence",id:"routine-maintainence",level:2},{value:"Patches and Upgrades",id:"patches-and-upgrades",level:3},{value:"AWS Service Limits",id:"aws-service-limits",level:3}],s={toc:d};function u(e){let{components:t,...n}=e;return(0,r.kt)("wrapper",(0,a.Z)({},s,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"operation-guidance"},"Operation Guidance"),(0,r.kt)("h2",{id:"checking-diego-health"},"Checking Diego Health"),(0,r.kt)("p",null,"Diego is composed of a number of collaborating components as described in the ",(0,r.kt)("a",{parentName:"p",href:"/documentation/docs/deployment-guide/introduction"},"introduction"),"."),(0,r.kt)("h3",{id:"check-argocd-is-running-and-available"},"Check ArgoCD is running and available"),(0,r.kt)("p",null,"ArgoCD is made up of the following controllers and services:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"diego-base-argocd-application-controller"),(0,r.kt)("li",{parentName:"ul"},"diego-base-argocd-applicationset-controller"),(0,r.kt)("li",{parentName:"ul"},"diego-base-argocd-notifications-controller"),(0,r.kt)("li",{parentName:"ul"},"diego-base-argocd-redis"),(0,r.kt)("li",{parentName:"ul"},"diego-base-argocd-repo-server"),(0,r.kt)("li",{parentName:"ul"},"diego-base-argocd-server")),(0,r.kt)("p",null,"Run the following command at your terminal and check there is a ",(0,r.kt)("inlineCode",{parentName:"p"},"running")," pod for each of these: "),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"kubectl get pods -n argocd \n")),(0,r.kt)("p",null,"The output should be similar:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"NAME                                                          READY   STATUS    RESTARTS   AGE\ndiego-base-argocd-application-controller-0                    1/1     Running   0          16d\ndiego-base-argocd-applicationset-controller-549bd598d-brbvs   1/1     Running   0          16d\ndiego-base-argocd-notifications-controller-587655488d-j2rbh   1/1     Running   0          16d\ndiego-base-argocd-redis-69d64848cb-zhpc2                      1/1     Running   0          16d\ndiego-base-argocd-repo-server-65d77f9549-vpjm7                1/1     Running   0          16d\ndiego-base-argocd-server-55f68f8dd4-n2v5g                     1/1     Running   0          16d\n")),(0,r.kt)("p",null,"Open the ArgoCD at ",(0,r.kt)("inlineCode",{parentName:"p"},"https://argocd.diego.<yourdomain>")," to check the UI is working"),(0,r.kt)("h3",{id:"check-argocd-managed-components-are-healthy"},"Check ArgoCD managed components are healthy"),(0,r.kt)("p",null,"ArgoCD is responsible for the deployment and health reporting of the following Diego components:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"aws-lb-controller            "),(0,r.kt)("li",{parentName:"ul"},"cert-manager                 "),(0,r.kt)("li",{parentName:"ul"},"dex                          "),(0,r.kt)("li",{parentName:"ul"},"diego-core                   "),(0,r.kt)("li",{parentName:"ul"},"diego-oauth2-proxy           "),(0,r.kt)("li",{parentName:"ul"},"external-dns-controller      "),(0,r.kt)("li",{parentName:"ul"},"external-secrets-operator    "),(0,r.kt)("li",{parentName:"ul"},"production-env-prerequisites "),(0,r.kt)("li",{parentName:"ul"},"project-applications         "),(0,r.kt)("li",{parentName:"ul"},"project-environments         "),(0,r.kt)("li",{parentName:"ul"},"root                         "),(0,r.kt)("li",{parentName:"ul"},"staging-env-prerequisites    ")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"kubectl get applications -n argocd \n")),(0,r.kt)("p",null,"Ensure the following components are reported as ",(0,r.kt)("inlineCode",{parentName:"p"},"Healthy")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"NAME                             SYNC STATUS   HEALTH STATUS\naws-lb-controller                OutOfSync     Healthy\ncert-manager                     Synced        Healthy\ndex                              Synced        Healthy\ndiego-core                       Synced        Healthy\ndiego-oauth2-proxy               Synced        Healthy\nexternal-dns-controller          Synced        Healthy\nexternal-secrets-operator        Synced        Healthy\nproduction-env-prerequisites     Synced        Healthy\nproject-applications             Synced        Healthy\nproject-environments             Synced        Healthy\nroot                             Synced        Healthy\nstaging-env-prerequisites        Synced        Healthy\n")),(0,r.kt)("h3",{id:"check-diego-hub-is-available"},"Check Diego Hub is available"),(0,r.kt)("p",null,"Open Diego Hub at ",(0,r.kt)("inlineCode",{parentName:"p"},"https://hub.diego.<yourdomain>")," to check the UI is working."),(0,r.kt)("h2",{id:"backup--recovery"},"Backup & Recovery"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Diego keeps it's state in four different managed services listed below. Diego delegates backup responsibility to these services."),(0,r.kt)("li",{parentName:"ul"},"We recommend you back up your EKS cluster state as this wll allow you to recover your cluster, including Diego and the deployment status of your applications and environments, to the most recent EKS state.",(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},"See ",(0,r.kt)("a",{parentName:"li",href:"https://aws.amazon.com/blogs/containers/backup-and-restore-your-amazon-eks-cluster-resources-using-velero/"},"this")," AWS blog outlining how this could be achieved using Velero.")))),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},"Service"),(0,r.kt)("th",{parentName:"tr",align:null},"State"),(0,r.kt)("th",{parentName:"tr",align:null},"SLA"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"AWS EKS (etcd)"),(0,r.kt)("td",{parentName:"tr",align:null},"Kubernetes state including all Diego API objects"),(0,r.kt)("td",{parentName:"tr",align:null})),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"AWS Systems Manager ParameterStore"),(0,r.kt)("td",{parentName:"tr",align:null},"Sensitive environment variables for your Diego managed applications"),(0,r.kt)("td",{parentName:"tr",align:null})),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"AWS CloudFormation"),(0,r.kt)("td",{parentName:"tr",align:null},"State of AWS resources and services configured as part of Diego deployment"),(0,r.kt)("td",{parentName:"tr",align:null})),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"GitHub"),(0,r.kt)("td",{parentName:"tr",align:null},"Representation of your Diego installation and also your deployed Diego managed environments and applications"),(0,r.kt)("td",{parentName:"tr",align:null})))),(0,r.kt)("p",null,"There are no specific backup instructions or tasks for Diego beyond the automated backup provided by the AWS services that it uses (above)."),(0,r.kt)("h3",{id:"recovery-with-eks-backup"},"Recovery with EKS backup"),(0,r.kt)("p",null,"Diego components will be restarted automatically once your EKS cluster is recovered. Your customer applications will be re-started by Diego, based on the last commits Diego has made to your default-project repository."),(0,r.kt)("p",null,"The RPO in this case is the last EKS commit to its backing store and the last commit to GitHub of the Diego application controller."),(0,r.kt)("p",null,"The RTO is approximately 30 minutes."),(0,r.kt)("h3",{id:"recovery-without-eks-backup"},"Recovery without EKS backup"),(0,r.kt)("p",null,"In this case the recommendation is to re-run the ",(0,r.kt)("a",{parentName:"p",href:"../deployment-guide/deployment-assets#command-5---deploy-diego-in-aws-eks"},"final installation step")," of Diego. After completing that step and confirming that Diego is ",(0,r.kt)("a",{parentName:"p",href:"../deployment-guide/operation-guidance#checking-diego-health"},"healthy")," you must then on-board your existing applications to Diego again using Diego Hub."),(0,r.kt)("p",null,"The RTO is approximately 30 minutes."),(0,r.kt)("h3",{id:"recovery-after-diego-component-failure"},"Recovery after Diego component failure"),(0,r.kt)("p",null,"This is handled by EKS. EKS will detect and restart unresponsive or unhealthy Diego components (pods)."),(0,r.kt)("h3",{id:"recovery-from-az-failure"},"Recovery from AZ failure"),(0,r.kt)("p",null,"The behaviour of Diego during an AZ failure depends on the wider configuration of the EKS cluster in which you have deployed Diego."),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("strong",{parentName:"p"},"EKS cluster with a single node in the affected AZ")," "),(0,r.kt)("p",{parentName:"li"},"Diego is unavailable. When the AZ recovers, the EKS node and Diego components running on it will be automatically recovered. No Diego state will be lost.")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("strong",{parentName:"p"},"EKS cluster with multiple nodes across multiple AZs")," "),(0,r.kt)("p",{parentName:"li"},"If Diego components are running on a node in the affected AZ then assuming there is capacity on other nodes the Kubernetes scheduler will start the Diego components on another available node. Diego will be unavailable until the components are re-started and are healthy on the other node. No Diego state will be lost."))),(0,r.kt)("h2",{id:"routine-maintainence"},"Routine Maintainence"),(0,r.kt)("p",null,"There are no routine maintainence tasks to perform for Diego."),(0,r.kt)("h3",{id:"patches-and-upgrades"},"Patches and Upgrades"),(0,r.kt)("p",null,"Diego components are deployed by ArgoCD. ArgoCD synchronizes the contents of the ",(0,r.kt)("inlineCode",{parentName:"p"},"diego-tooling")," repository in your GitHub organisation as Diego components running in your EKS cluster. To update Diego you must commit changes to this repository and synchronize these changes to your EKS cluster via ArgoCD."),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},"Deployment"),(0,r.kt)("th",{parentName:"tr",align:null},"Image Version"),(0,r.kt)("th",{parentName:"tr",align:null},"Chart"),(0,r.kt)("th",{parentName:"tr",align:null},"Patch/Upgrade Strategy"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"Diego Application Controller"),(0,r.kt)("td",{parentName:"tr",align:null},"latest"),(0,r.kt)("td",{parentName:"tr",align:null},"diego-core v0.20.0"),(0,r.kt)("td",{parentName:"tr",align:null},"Each restart of this component pulls the latest image from the Diego public DockerHub repository")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"Diego Hub"),(0,r.kt)("td",{parentName:"tr",align:null},"latest"),(0,r.kt)("td",{parentName:"tr",align:null},"diego-core v0.20.0"),(0,r.kt)("td",{parentName:"tr",align:null},"Each restart of this component pulls the latest image from the Diego public DockerHub repository")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"Diego API"),(0,r.kt)("td",{parentName:"tr",align:null},"latest"),(0,r.kt)("td",{parentName:"tr",align:null},"diego-core v0.20.0"),(0,r.kt)("td",{parentName:"tr",align:null},"Each restart of this component pulls the latest image from the Diego public DockerHub repository")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"OAuth2 Proxy"),(0,r.kt)("td",{parentName:"tr",align:null},"v7.4.0"),(0,r.kt)("td",{parentName:"tr",align:null},"oauth2-proxy v6.5.0"),(0,r.kt)("td",{parentName:"tr",align:null},"Update ",(0,r.kt)("inlineCode",{parentName:"td"},"diego-oauth2-proxy.yaml")," application manifest in your ",(0,r.kt)("inlineCode",{parentName:"td"},"diego-tooling")," repository and manually sync in ArgoCD")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"ArgoCD"),(0,r.kt)("td",{parentName:"tr",align:null},"v2.5.1"),(0,r.kt)("td",{parentName:"tr",align:null},"diego-base v5.13.2",(0,r.kt)("br",null),"argo-cd v15.3.2"),(0,r.kt)("td",{parentName:"tr",align:null},"Updates not yet directly supported, coming in next release of Diego CLI")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"Dex"),(0,r.kt)("td",{parentName:"tr",align:null},"v2.35.3"),(0,r.kt)("td",{parentName:"tr",align:null},"dex v0.12.1"),(0,r.kt)("td",{parentName:"tr",align:null},"Update ",(0,r.kt)("inlineCode",{parentName:"td"},"dex.yaml")," application manifest in your ",(0,r.kt)("inlineCode",{parentName:"td"},"diego-tooling")," repository and manually sync in ArgoCD")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"AWS Load Balancer Controller"),(0,r.kt)("td",{parentName:"tr",align:null},"v2.4.1"),(0,r.kt)("td",{parentName:"tr",align:null},"aws-load-balancer-controller v1.4.1"),(0,r.kt)("td",{parentName:"tr",align:null},"Update ",(0,r.kt)("inlineCode",{parentName:"td"},"aws-lb-controller.yaml")," application manifest in your ",(0,r.kt)("inlineCode",{parentName:"td"},"diego-tooling")," repository and manually sync in ArgoCD")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"DNS Controller"),(0,r.kt)("td",{parentName:"tr",align:null},"v0.10.2"),(0,r.kt)("td",{parentName:"tr",align:null},"external-dns v1.7.1"),(0,r.kt)("td",{parentName:"tr",align:null},"Update ",(0,r.kt)("inlineCode",{parentName:"td"},"external-dns-controller.yaml")," application manifest in your ",(0,r.kt)("inlineCode",{parentName:"td"},"diego-tooling")," repository and manually sync in ArgoCD")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"External Secrets Operator"),(0,r.kt)("td",{parentName:"tr",align:null},"v0.5.9"),(0,r.kt)("td",{parentName:"tr",align:null},"external-secrets v0.5.9"),(0,r.kt)("td",{parentName:"tr",align:null},"Update ",(0,r.kt)("inlineCode",{parentName:"td"},"external-secrets-operator.yaml")," application manifest in your ",(0,r.kt)("inlineCode",{parentName:"td"},"diego-tooling")," repository and manually sync in ArgoCD")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"Cert Manager Controller"),(0,r.kt)("td",{parentName:"tr",align:null},"v1.8.2"),(0,r.kt)("td",{parentName:"tr",align:null},"cert-manager v1.8.2"),(0,r.kt)("td",{parentName:"tr",align:null},"Update ",(0,r.kt)("inlineCode",{parentName:"td"},"cert-manager.yaml")," application manifest in your ",(0,r.kt)("inlineCode",{parentName:"td"},"diego-tooling")," repository and manually sync in ArgoCD")))),(0,r.kt)("p",null,"Managing Licenses"),(0,r.kt)("h3",{id:"aws-service-limits"},"AWS Service Limits"),(0,r.kt)("p",null,"If you are running your EKS cluster on EC2 nodes then it is important to consider the ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/awslabs/amazon-eks-ami/blob/master/files/eni-max-pods.txt"},"limits on the number of pods that can run on a given EC2 instance type")," as this will set a capacity on the number of remaining pods you have available run your own applications. "),(0,r.kt)("p",null,"For example, assuming you are running a minimally sized EKS cluster with a single t3.large node:"),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},"Node Type"),(0,r.kt)("th",{parentName:"tr",align:null},"Max Pods"),(0,r.kt)("th",{parentName:"tr",align:null},"Diego Usage (pods)"),(0,r.kt)("th",{parentName:"tr",align:null},"Other Required Cluster Services (pods)"),(0,r.kt)("th",{parentName:"tr",align:null},"Remaining Capacity for your applications (pods)"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"t3.large")),(0,r.kt)("td",{parentName:"tr",align:null},"35"),(0,r.kt)("td",{parentName:"tr",align:null},"20"),(0,r.kt)("td",{parentName:"tr",align:null},"4"),(0,r.kt)("td",{parentName:"tr",align:null},"11")))),(0,r.kt)("p",null,"EMERGENCY MAINTENANCE"),(0,r.kt)("p",null,"Provide step-by-step instructions for actions to take in the event of fault conditions, such as a transient failure of an AWS Service (e.g. availability of Amazon EC2 in a particular AZ is degraded), or a more permanent failure of an AWS service (e.g. EC2 instance has faulted, EC2 Scheduled Maintenance Event has been received). The following are required:"),(0,r.kt)("ul",{className:"contains-task-list"},(0,r.kt)("li",{parentName:"ul",className:"task-list-item"},(0,r.kt)("input",{parentName:"li",type:"checkbox",checked:!1,disabled:!0})," ","Step-by-step instructions on handling fault conditions "),(0,r.kt)("li",{parentName:"ul",className:"task-list-item"},(0,r.kt)("input",{parentName:"li",type:"checkbox",checked:!1,disabled:!0})," ","Step-by-step instructions on how to recover software")))}u.isMDXComponent=!0}}]);